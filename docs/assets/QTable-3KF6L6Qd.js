import{b as n,p as b,e as u,d as g}from"./__uno-x_vZtz2U.js";import{CTable as _}from"./CTable-DWGVAplU.js";import{v as w,u as C,w as m,x as h,y as $,z as x,i as S,h as A,s as D,n as V}from"./game-C6B8_-6p.js";import{v}from"./view-BbfiM190.js";var T=Object.defineProperty,j=Object.getOwnPropertyDescriptor,q=Object.getPrototypeOf,I=Reflect.get,Q=(e,t,s)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,N=(e,t,s,a)=>{for(var r=a>1?void 0:a?j(t,s):t,l=e.length-1,o;l>=0;l--)(o=e[l])&&(r=(a?o(t,s,r):o(r))||r);return a&&r&&T(t,s,r),r},B=(e,t,s)=>(Q(e,t+"",s),s),E=(e,t,s)=>I(q(e),s,t);let i=class extends _{canUnlock(e){const t=n.techs;return!t.has(e.name)&&e.prereqs.every(s=>this.items.some(a=>a.name==s&&t.has(a.name)))}async updateContents(e,t){this.items=b(w,e,t)}unlock(e){const t=v.selectedSlot;if(t<0){u("请先选择一个研究设施");return}y({name:"研究"+e.name,desc:"",slot:t,remainTime:e.time,recipeId:-1,value:-1}),this.updateValue("item")}unlocked(e){return n.techs.has(e.name)}};B(i,"observedAttributes",E(i,i,"observedAttributes"));i=N([g("tech-tree")],i);const[p]=document.getElementsByTagName("tech-tree");function O(){p.updateContents(p.page,p.filter)}const Z=Object.freeze(Object.defineProperty({__proto__:null,get TechTree(){return i},updateTechs:O},Symbol.toStringTag,{value:"Module"}));var P=Object.defineProperty,G=Object.getOwnPropertyDescriptor,M=Object.getPrototypeOf,z=Reflect.get,R=(e,t,s)=>t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,F=(e,t,s,a)=>{for(var r=a>1?void 0:a?G(t,s):t,l=e.length-1,o;l>=0;l--)(o=e[l])&&(r=(a?o(t,s,r):o(r))||r);return a&&r&&P(t,s,r),r},U=(e,t,s)=>(R(e,t+"",s),s),L=(e,t,s)=>z(M(e),s,t);const[H]=document.getElementsByTagName("game-menu");function J(e){const t=e.slot;if(e.value<0)n.techs.add(e.name.substring(2)),O();else{m(t,e.value);const a=e.value&255,[r]=A(a);r&&D(t,r.id,r.period),t==v.selectedSlot&&H.updateValue("selectedSlot")}n.tasks.splice(n.tasks.findIndex(f(e)),1);const s=n.stats;switch(e.name.substring(0,2)){case"建造":s.totalBuild++;break;case"升级":s.totalUpgrade++;break;case"降级":case"拆除":s.totalDestroy++;break}}let c=class extends _{maxTasks=10;get selectAll(){return this.items.length>0&&this.items.every(e=>e.selected)}set selectAll(e){this.items.forEach(t=>t.selected=e)}get selectedCount(){return this.items.filter(e=>e.selected).length}connectedCallback(){super.connectedCallback(),C.add(()=>this.updateQueue())}render(e,t){switch(typeof t){case"number":return e=="time"?new Date(t).toLocaleString():t+""}return t??""}updateQueue(){for(let e=0;e<this.items.length;){const t=this.items[e++];t.paused||(this.update(t)?(!n.mode||--t.remainTime<=0)&&(this.items.splice(--e,1),d.page.updateValue("data"),J(t)):t.paused=!0)}}update(e){if(e.value>=0){const s=Math.round(7*e.remainTime/e.time);m(e.slot,e.value|s<<12)}let t=e.recipeId>=0?h(e.slot,e.recipeId,e.k||1):0;if(t==3&&(t=h(-1,e.recipeId,e.k||1)),t){let s=`${e.name}已暂停：`;(t&255)>4&&(s+=V[t>>8]),u(s+$[t&255])}return t==0}switch(){for(const e of this.items)e.selected&&(e.paused=!e.paused)}cancel(){const e=n.tasks,t=this.items;for(let s=t.length;--s>=0;){const a=t[s];if(a.selected){const r=e.findIndex(f(a));r>=0&&(e.splice(r,1),m(a.slot,a.oldValue),d.page.updateValue("data"))}}}async updateContents(e,t){this.items=b(n.tasks,e,t)}toCoord=x};U(c,"observedAttributes",L(c,c,"observedAttributes"));c=F([g("q-table")],c);const[d]=document.getElementsByTagName("q-table"),f=e=>t=>t.slot==e.slot;function y(e){if(n.tasks.length>=d.maxTasks)u("任务队列已满");else{if(n.tasks.find(f(e))){u("该位置已有任务");return}e.time=e.remainTime;const t=S(e.slot);e.oldValue=t[2]|(t[3]&15)<<8,n.tasks.push(e),d.page.updateValue("data")}}const k=Object.freeze(Object.defineProperty({__proto__:null,get QTable(){return c},queue:y},Symbol.toStringTag,{value:"Module"}));export{k as Q,Z as T,y as q};
